pipeline {
    agent any

    environment {
        APP_DIR = '/home/ubuntu/InventoryAutomation'
        DEPLOY_USER = 'ubuntu'
        DEPLOY_HOST = 'ec2-51-20-182-249.eu-north-1.compute.amazonaws.com'
    }

    stages {
        stage('Checkout Code') {
            steps {
                echo 'Code already checked out in Declarative SCM phase'
            }
        }

        stage('Run Selenium Tests') {
            steps {
                script {
                    docker.image('markhobson/maven-chrome').inside('-u root') {
                        withEnv(["MAVEN_CONFIG=/tmp/.m2"]) {
                            dir('InventoryApp') {
                                sh 'mvn test'
                            }
                        }
                    }
                }
            }
        }

        stage('Deploy to EC2') {
            steps {
                sshagent(credentials: ['ec2-ssh']) {
                    sh '''
                        ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST '
                            cd $APP_DIR &&
                            git pull origin main &&
                            cd server && npm install &&
                            pm2 restart backend || pm2 start index.js --name server &&
                            cd ../inventory &&
                            npm install &&
                            pm2 serve build 3000 --name inventory --spa
                        '
                    '''
                }
            }
        }
    }

    post {
        always {
            echo 'Pipeline Execution Finished'
        }
    }
}
