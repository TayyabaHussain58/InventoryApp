pipeline {
    agent any

    environment {
        APP_DIR = '/home/ubuntu/InventoryAutomation'
        DEPLOY_USER = 'ubuntu'
        DEPLOY_HOST = 'ec2-51-20-182-249.eu-north-1.compute.amazonaws.com'
    }

    stages {
        stage('Checkout Code') {
            steps {
                echo 'Code already checked out in Declarative SCM phase'
            }
        }

        stage('Run Selenium Tests') {
            steps {
                script {
                    docker.image('markhobson/maven-chrome').inside('-u root') {
                        withEnv(["MAVEN_CONFIG=/tmp/.m2"]) {
                            // Adjust this if your test code is somewhere specific
                            sh 'mvn test'
                        }
                    }
                }
            }
        }

        stage('Deploy to EC2') {
            steps {
                sshagent(credentials: ['ec2-ssh']) {
                    sh '''
                        ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST << 'ENDSSH'
                            cd $APP_DIR
                            git pull origin main

                            # Backend setup inside src/server
                            cd src/server
                            npm install
                            pm2 restart backend || pm2 start index.js --name backend

                            # Frontend build from root
                            cd ../../
                            npm install
                            npm run build

                            # Serve frontend build with PM2
                            pm2 serve build 3000 --name frontend --spa
                        ENDSSH
                    '''
                }
            }
        }
    }

    post {
        always {
            echo 'Pipeline Execution Finished'
        }
    }
}
