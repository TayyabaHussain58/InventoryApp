pipeline {
    agent any

    environment {
        DEPLOY_USER = "ubuntu"
        DEPLOY_HOST = 'ec2-51-20-182-249.eu-north-1.compute.amazonaws.com'
        APP_DIR = "/home/ubuntu/app"
    }

    stages {
        stage('Clone') {
            steps {
                git 'https://github.com/TayyabaHussain58/InventoryApp-.git'
            }
        }

        stage('Install Dependencies') {
            steps {
                sh 'npm install'
            }
        }

        stage('Deploy to EC2') {
            steps {
                sshagent(credentials: ['ec2-ssh']) {
                    sh '''
                    ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST << 'ENDSSH'
                        set -e

                        # Clone or Pull Code
                        if [ -d "$APP_DIR" ]; then
                            cd $APP_DIR && git pull
                        else
                            git clone https://github.com/TayyabaHussain58/InventoryApp-.git $APP_DIR
                            cd $APP_DIR
                        fi

                        npm install

                        # Start/Restart Backend
                        if pm2 list | grep -q backend; then
                            pm2 restart backend
                        else
                            pm2 start npm --name backend -- run server
                        fi

                        # Start/Restart Frontend
                        if pm2 list | grep -q frontend; then
                            pm2 restart frontend
                        else
                            pm2 start npm --name frontend -- run dev
                        fi

                    ENDSSH
                    '''
                }
            }
        }
    }
}
